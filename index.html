<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Báo Cáo Vi Phạm</title>
    <link rel="icon" href="https://raw.githubusercontent.com/duongcanhquan/image/main/logo%20vietmy.webp">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; background-color: #f0f2f5; }
        .main-container { max-width: 800px; margin: 2rem auto; padding: 2rem; }
        .header { text-align: center; margin-bottom: 2rem; }
        .header img { max-width: 150px; margin-bottom: 1rem; }
        .header h1 { color: #1a237e; font-weight: 700; }
        .card-selector { transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; border: none; border-radius: 15px; }
        .card-selector:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card-title { color: #1a237e; font-weight: 700; }
        .form-section { display: none; background-color: white; padding: 2rem; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .form-label { font-weight: 500; }
        .btn-primary { background-color: #283593; border-color: #283593; font-weight: 500; padding: 10px 20px; border-radius: 8px; }
        .btn-primary:hover { background-color: #1a237e; border-color: #1a237e; }
        .btn-secondary { border-radius: 8px; }
        #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; }
        .violation-entry { border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; position: relative; }
        .remove-entry { position: absolute; top: 10px; right: 10px; cursor: pointer; color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loader" class="d-flex justify-content-center align-items-center">
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <div class="main-container">
        <div class="header">
            <img src="https://raw.githubusercontent.com/duongcanhquan/image/main/logo%20vietmy.webp" alt="Logo Trường">
            <h1 id="main-title">Hệ Thống Báo Cáo Vi Phạm</h1>
        </div>

        <div id="main-selection">
            <div class="row g-4">
                <div class="col-lg-4 col-md-12 mb-3"><div class="card card-selector h-100" onclick="showForm('saodo')"><div class="card-body text-center"><h5 class="card-title">Hoạt động Sao Đỏ</h5><p class="card-text text-muted">Ghi nhận các hoạt động thường nhật của đội Sao Đỏ.</p></div></div></div>
                <div class="col-lg-4 col-md-12 mb-3"><div class="card card-selector h-100" onclick="showForm('canhan')"><div class="card-body text-center"><h5 class="card-title">Vi phạm Cá nhân</h5><p class="card-text text-muted">Lập biên bản các vi phạm của từng học sinh.</p></div></div></div>
                <div class="col-lg-4 col-md-12 mb-3"><div class="card card-selector h-100" onclick="showForm('tapthe')"><div class="card-body text-center"><h5 class="card-title">Vi phạm Tập thể</h5><p class="card-text text-muted">Lập biên bản các vi phạm của cả lớp học.</p></div></div></div>
            </div>
        </div>

        <div id="reporter-name-section" class="form-section">
             <h2 class="mb-4 text-center">Thông tin người báo cáo</h2>
             <div class="mb-3">
                <label for="reporterName" class="form-label">Tên của bạn (Sao đỏ/Giám thị):</label>
                <input type="text" class="form-control" id="reporterName" placeholder="Ví dụ: Nguyễn Văn A" required>
            </div>
            <button type="button" class="btn btn-primary w-100" onclick="startReporting()">Bắt đầu báo cáo</button>
        </div>

        <div id="form-saodo" class="form-section">
            <h2 class="mb-4 text-center">Ghi nhận Hoạt động Sao Đỏ</h2>
            <form id="saodo-form">
                <div class="mb-3"><label for="saodo-name" class="form-label">Người vi phạm <span class="text-danger">*</span></label><input type="text" class="form-control" id="saodo-name" required></div>
                <div class="mb-3"><label for="saodo-class" class="form-label">Lớp <span class="text-danger">*</span></label><input type="text" class="form-control" id="saodo-class" required></div>
                <div class="mb-3"><label for="saodo-problems" class="form-label">Vấn đề vi phạm <span class="text-danger">*</span></label><textarea class="form-control" id="saodo-problems" rows="3" required></textarea></div>
                <div class="mb-3"><label for="saodo-session" class="form-label">Buổi học <span class="text-danger">*</span></label><select class="form-select" id="saodo-session" required><option selected disabled value="">Chọn buổi học</option><option>Buổi sáng</option><option>Buổi chiều</option></select></div>
                <div class="mb-3"><label class="form-label">Ảnh vi phạm (Tối đa 3 ảnh)</label><input class="form-control" type="file" id="saodo-photo1" accept="image/*" capture="camera"><input class="form-control mt-2" type="file" id="saodo-photo2" accept="image/*" capture="camera"><input class="form-control mt-2" type="file" id="saodo-photo3" accept="image/*" capture="camera"></div>
                <div class="d-flex justify-content-between mt-4"><button type="button" class="btn btn-secondary" onclick="goBack()">Quay lại</button><button type="submit" class="btn btn-primary">Gửi báo cáo</button></div>
            </form>
        </div>
        
        <div id="form-canhan" class="form-section">
            <h2 class="mb-4 text-center">Lập biên bản Vi phạm Cá nhân</h2>
            <form id="canhan-form"><div id="canhan-entries"></div><button type="button" class="btn btn-outline-primary mt-2" onclick="addCanhanEntry()">+ Thêm vi phạm</button><div class="d-flex justify-content-between mt-4"><button type="button" class="btn btn-secondary" onclick="goBack()">Quay lại</button><button type="submit" class="btn btn-primary">Gửi tất cả</button></div></form>
        </div>

        <div id="form-tapthe" class="form-section">
            <h2 class="mb-4 text-center">Lập biên bản Vi phạm Tập thể</h2>
            <form id="tapthe-form"><div id="tapthe-entries"></div><button type="button" class="btn btn-outline-primary mt-2" onclick="addTaptheEntry()">+ Thêm vi phạm</button><div class="d-flex justify-content-between mt-4"><button type="button" class="btn btn-secondary" onclick="goBack()">Quay lại</button><button type="submit" class="btn btn-primary">Gửi tất cả</button></div></form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // =========================================================================
        // // =========================================================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby5mnwO3kmGE1WJyUl-C6nC2y4osOihcRs3JbTvK1NrrombpsmCCGSv-mkYK0we9llQoQ/exec"; 
        // =========================================================================

        document.addEventListener('DOMContentLoaded', function() {
            let currentForm = '';
            let reporterName = '';
            const responsiveList = [ 'Đinh Thị Phương Hà', 'Dung Nguyễn', 'Lê Thị Quỳnh Mai', 'Đinh Thị Hiền', 'Phùng Khánh Ly', 'Ngô Thị Nhã Uyên', 'Đinh Thị Hà', 'Trần Hồng Hạnh' ];

            // --- Gán các hàm vào đối tượng window để HTML có thể gọi được ---
            window.showForm = function(formType) {
                currentForm = formType;
                document.getElementById('main-selection').style.display = 'none';
                document.getElementById('reporter-name-section').style.display = 'block';
                document.getElementById('main-title').textContent = 'Xác nhận thông tin';
            }
            
            window.startReporting = function() {
                reporterName = document.getElementById('reporterName').value.trim();
                if (!reporterName) { alert('Vui lòng nhập tên của bạn!'); return; }
                document.getElementById('reporter-name-section').style.display = 'none';
                const formElement = document.getElementById('form-' + currentForm);
                formElement.style.display = 'block';
                document.getElementById('main-title').textContent = formElement.querySelector('h2').textContent;
                if (currentForm === 'canhan' && document.getElementById('canhan-entries').childElementCount === 0) { addCanhanEntry(); }
                if (currentForm === 'tapthe' && document.getElementById('tapthe-entries').childElementCount === 0) { addTaptheEntry(); }
            }

            window.goBack = function() {
                document.getElementById('canhan-entries').innerHTML = '';
                document.getElementById('tapthe-entries').innerHTML = '';
                document.getElementById('saodo-form').reset();
                document.getElementById('reporterName').value = '';
                ['form-saodo', 'form-canhan', 'form-tapthe', 'reporter-name-section'].forEach(id => document.getElementById(id).style.display = 'none');
                document.getElementById('main-selection').style.display = 'block';
                document.getElementById('main-title').textContent = 'Hệ Thống Báo Cáo Vi Phạm';
                currentForm = ''; reporterName = '';
            }

            let canhanCounter = 0;
            window.addCanhanEntry = function() {
                canhanCounter++;
                const responsiveOptions = responsiveList.map(name => `<option value="${name}">${name}</option>`).join('');
                const html = `<div class="violation-entry" id="canhan-entry-${canhanCounter}">${canhanCounter > 1 ? `<span class="remove-entry" onclick="removeEntry('canhan-entry-${canhanCounter}')">✖</span>` : ''}<h5>Vi phạm #${canhanCounter}</h5><div class="mb-3"><label class="form-label">Người vi phạm <span class="text-danger">*</span></label><input type="text" class="form-control canhan-name" required></div><div class="mb-3"><label class="form-label">Lớp <span class="text-danger">*</span></label><input type="text" class="form-control canhan-class" required></div><div class="mb-3"><label class="form-label">Vấn đề vi phạm <span class="text-danger">*</span></label><textarea class="form-control canhan-problems" rows="3" required></textarea></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Ca học <span class="text-danger">*</span></label><select class="form-select canhan-session" required><option selected disabled value="">Chọn ca</option><option>Ca sáng</option><option>Ca chiều</option></select></div><div class="col-md-6 mb-3"><label class="form-label">Người phụ trách <span class="text-danger">*</span></label><select class="form-select canhan-responsive" required><option selected disabled value="">Chọn người</option>${responsiveOptions}</select></div></div><div class="mb-3"><label class="form-label">Ảnh vi phạm (Tối đa 3)</label><input class="form-control canhan-photo1" type="file" accept="image/*" capture="camera"><input class="form-control mt-2 canhan-photo2" type="file" accept="image/*" capture="camera"><input class="form-control mt-2 canhan-photo3" type="file" accept="image/*" capture="camera"></div><div class="mb-3"><label class="form-label">Biên bản</label><input class="form-control canhan-doc" type="file" accept="image/*,application/pdf"></div></div>`;
                document.getElementById('canhan-entries').insertAdjacentHTML('beforeend', html);
            }

            let taptheCounter = 0;
            window.addTaptheEntry = function() {
                taptheCounter++;
                const responsiveOptions = responsiveList.map(name => `<option value="${name}">${name}</option>`).join('');
                const html = `<div class="violation-entry" id="tapthe-entry-${taptheCounter}">${taptheCounter > 1 ? `<span class="remove-entry" onclick="removeEntry('tapthe-entry-${taptheCounter}')">✖</span>` : ''}<h5>Vi phạm #${taptheCounter}</h5><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Lớp vi phạm <span class="text-danger">*</span></label><input type="text" class="form-control tapthe-class" required></div><div class="col-md-6 mb-3"><label class="form-label">Phòng học</label><input type="text" class="form-control tapthe-room"></div></div><div class="mb-3"><label class="form-label">Vấn đề vi phạm <span class="text-danger">*</span></label><textarea class="form-control tapthe-problems" rows="3" required></textarea></div><div class="row"><div class="col-md-6 mb-3"><label class="form-label">Ca học <span class="text-danger">*</span></label><select class="form-select tapthe-session" required><option selected disabled value="">Chọn ca</option><option>Ca sáng</option><option>Ca chiều</option></select></div><div class="col-md-6 mb-3"><label class="form-label">Người phụ trách <span class="text-danger">*</span></label><select class="form-select tapthe-responsive" required><option selected disabled value="">Chọn người</option>${responsiveOptions}</select></div></div><div class="mb-3"><label class="form-label">Ảnh vi phạm (Tối đa 3)</label><input class="form-control tapthe-photo1" type="file" accept="image/*" capture="camera"><input class="form-control mt-2 tapthe-photo2" type="file" accept="image/*" capture="camera"><input class="form-control mt-2 tapthe-photo3" type="file" accept="image/*" capture="camera"></div><div class="mb-3"><label class="form-label">Biên bản</label><input class="form-control tapthe-doc" type="file" accept="image/*,application/pdf"></div></div>`;
                document.getElementById('tapthe-entries').insertAdjacentHTML('beforeend', html);
            }
            
            window.removeEntry = function(id) { document.getElementById(id)?.remove(); }

            const fileToBase64 = file => new Promise(resolve => {
                if (!file) return resolve({ base64: null, name: null });
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve({ base64: reader.result, name: file.name });
                reader.onerror = () => resolve({ base64: null, name: null });
            });
            
            const toggleLoader = show => { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

            async function postData(action, payload) {
                if (!SCRIPT_URL || SCRIPT_URL === "DÁN_URL_APPS_SCRIPT_CỦA_BẠN_VÀO_ĐÂY") {
                    alert("LỖI CẤU HÌNH: Bạn chưa dán URL của Google Apps Script vào file index.html!");
                    return;
                }
                toggleLoader(true);
                try {
                    const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action, payload }), headers: { 'Content-Type': 'application/json' }, mode: 'cors' });
                    if (!response.ok) throw new Error(`Lỗi mạng: ${response.status} ${response.statusText}`);
                    const result = await response.json();
                    if (result.status === 'success') {
                        alert(result.data.message);
                        goBack();
                    } else {
                        throw new Error(result.message || 'Lỗi không xác định từ backend.');
                    }
                } catch (error) {
                    alert("Đã có lỗi nghiêm trọng xảy ra: " + error.message);
                    console.error('Chi tiết lỗi:', error);
                } finally {
                    toggleLoader(false);
                }
            }

            document.getElementById('saodo-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const [p1, p2, p3] = await Promise.all([ fileToBase64(this.querySelector('#saodo-photo1').files[0]), fileToBase64(this.querySelector('#saodo-photo2').files[0]), fileToBase64(this.querySelector('#saodo-photo3').files[0]) ]);
                const payload = { name: this.querySelector('#saodo-name').value, class: this.querySelector('#saodo-class').value, problems: this.querySelector('#saodo-problems').value, session: this.querySelector('#saodo-session').value, redstart: reporterName, photo1_base64: p1.base64, photo1_name: p1.name, photo2_base64: p2.base64, photo2_name: p2.name, photo3_base64: p3.base64, photo3_name: p3.name };
                postData('submitHoatdongsaodo', payload);
            });

            document.getElementById('canhan-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const entries = this.querySelectorAll('.violation-entry');
                if (entries.length === 0) { alert('Vui lòng thêm ít nhất một vi phạm.'); return; }
                
                const allViolationsData = await Promise.all(Array.from(entries).map(async entry => {
                    const [p1, p2, p3, doc] = await Promise.all([ fileToBase64(entry.querySelector('.canhan-photo1').files[0]), fileToBase64(entry.querySelector('.canhan-photo2').files[0]), fileToBase64(entry.querySelector('.canhan-photo3').files[0]), fileToBase64(entry.querySelector('.canhan-doc').files[0]) ]);
                    return { name: entry.querySelector('.canhan-name').value, class: entry.querySelector('.canhan-class').value, problems: entry.querySelector('.canhan-problems').value, session: entry.querySelector('.canhan-session').value, responsive: entry.querySelector('.canhan-responsive').value, redstart: reporterName, photo1_base64: p1.base64, photo1_name: p1.name, photo2_base64: p2.base64, photo2_name: p2.name, photo3_base64: p3.base64, photo3_name: p3.name, doc_base64: doc.base64, doc_name: doc.name };
                }));
                postData('submitViphamcanhan', allViolationsData);
            });
            
            document.getElementById('tapthe-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const entries = this.querySelectorAll('.violation-entry');
                if (entries.length === 0) { alert('Vui lòng thêm ít nhất một vi phạm.'); return; }

                const allViolationsData = await Promise.all(Array.from(entries).map(async entry => {
                    const [p1, p2, p3, doc] = await Promise.all([ fileToBase64(entry.querySelector('.tapthe-photo1').files[0]), fileToBase64(entry.querySelector('.tapthe-photo2').files[0]), fileToBase64(entry.querySelector('.tapthe-photo3').files[0]), fileToBase64(entry.querySelector('.tapthe-doc').files[0]) ]);
                    return { class: entry.querySelector('.tapthe-class').value, room: entry.querySelector('.tapthe-room').value, problems: entry.querySelector('.tapthe-problems').value, session: entry.querySelector('.tapthe-session').value, responsive: entry.querySelector('.tapthe-responsive').value, redstart: reporterName, photo1_base64: p1.base64, photo1_name: p1.name, photo2_base64: p2.base64, photo2_name: p2.name, photo3_base64: p3.base64, photo3_name: p3.name, doc_base64: doc.base64, doc_name: doc.name };
                }));
                postData('submitBaoloitapthe', allViolationsData);
            });
        });
    </script>
</body>
</html>
