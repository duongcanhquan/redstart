<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THÔNG TIN SAO ĐỎ</title>

  <!-- Font Nunito (tròn, rõ ràng, hiện đại) -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: linear-gradient(135deg,#0ea5e9,#7c3aed);
      --surface:#fff; --ink:#0f172a; --muted:#637081; --border:#e5e7eb;
      --accent:#7c3aed; --accent2:#0ea5e9;
      --radius:16px; --shadow:0 18px 40px rgba(0,0,0,.12);
      --fs-base: clamp(16px, 2.4vw, 18px);
      --fs-sm: clamp(13px, 2vw, 15px);
      --fs-lg: clamp(17px, 2.4vw, 20px);
      --fs-xl: clamp(22px, 3.2vw, 28px);
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:"Nunito",sans-serif;color:var(--ink);font-size:var(--fs-base);}
    .app{max-width:1080px;margin:12px auto;background:#fff;border-radius:24px;box-shadow:var(--shadow);}
    header{background:#0b1020;color:#fff;padding:12px 16px;border-radius:24px 24px 0 0;}
    header h1{margin:0;font-size:var(--fs-xl);font-weight:800}
    header p{margin:4px 0 0;font-size:var(--fs-sm);color:#cbd5e1;font-weight:600}
    .tabbar-wrap{background:#f5f7fb;padding:10px;border-top:1px solid #e2e8f0;border-bottom:1px solid #e2e8f0;}
    .tabbar{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
    .tab{padding:10px 12px;border-radius:12px;background:#f8fafc;border:1px solid #e2e8f0;font-weight:800;cursor:pointer;}
    .tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;}
    @media(max-width:720px){.tabbar{grid-template-columns:1fr}}
    main{padding:14px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:12px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    @media(max-width:768px){.grid{grid-template-columns:1fr}}
    label{font-size:var(--fs-sm);font-weight:800;display:block;margin-bottom:6px;color:#475569}
    input,select,textarea{width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:12px;font-family:inherit;font-size:var(--fs-base)}
    textarea{min-height:100px}
    input:focus,select:focus,textarea:focus{border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,.12)}
    .btn{padding:12px 14px;border:none;border-radius:12px;cursor:pointer;font-weight:800;}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;}
    .btn.secondary{background:linear-gradient(135deg,#0284c7,#06b6d4);color:#fff;}
    .btn.ghost{background:#fff;border:1px solid #e2e8f0;}
    .fieldset{border:1px dashed #d1d5db;border-radius:12px;padding:12px;background:#fafafa}
    .status{margin-top:6px;font-size:var(--fs-sm)}
    .status.ok{color:#065f46}
    #notice{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);background:#fff;padding:10px;border:1px solid #fbbf24;border-left:6px solid #f59e0b;border-radius:12px;box-shadow:0 14px 28px rgba(0,0,0,.12);display:none;z-index:1000;}
    #notice.ok{border-left-color:#10b981;border-color:#a7f3d0;color:#065f46;}
  </style>
</head>

<body>
<div class="app">
  <header>
    <h1>THÔNG TIN SAO ĐỎ</h1>
    <p>Hệ thống ghi nhận báo cáo vi phạm</p>
  </header>

  <div class="tabbar-wrap">
    <div class="tabbar">
      <button class="tab active" data-tab="hoatdong">Hoạt động sao đỏ</button>
      <button class="tab" data-tab="canhan">Vi phạm cá nhân</button>
      <button class="tab" data-tab="tapthe">Vi phạm tập thể</button>
      <button id="btn-fee-info" class="btn ghost">Mức phạt & Chuyển khoản</button>
    </div>
  </div>

  <main>
    <!-- TAB 1: Hoạt động sao đỏ -->
    <section id="tab-hoatdong" class="card">
      <div class="grid">
        <div><label>Người khai báo *</label><input id="hd-redstart" type="text"></div>
        <div><label>Ca học *</label><select id="hd-session"><option>Ca sáng</option><option>Ca chiều</option></select></div>
      </div>
      <div id="hd-list"></div>
      <div class="row" style="margin-top:8px">
        <button class="btn secondary" id="hd-add">+ Thêm trường hợp</button>
      </div>
      <div style="margin-top:8px"><button class="btn primary" id="hd-submit">Gửi tất cả</button></div>
      <div id="hd-status" class="status"></div>
    </section>

    <!-- TAB 2: Vi phạm cá nhân -->
    <section id="tab-canhan" class="card hidden">
      <div class="grid">
        <div><label>Người khai báo *</label><input id="cn-redstart" type="text"></div>
        <div><label>Ca học *</label><select id="cn-session"><option>Ca sáng</option><option>Ca chiều</option></select></div>
        <div style="grid-column:1/-1"><label>Người phụ trách *</label><select id="cn-responsive"></select></div>
      </div>
      <div id="cn-list"></div>
      <div class="row" style="margin-top:8px"><button class="btn secondary" id="cn-add">+ Thêm cá nhân</button></div>
      <div style="margin-top:8px"><button class="btn primary" id="cn-submit">Gửi tất cả</button></div>
      <div id="cn-status" class="status"></div>
    </section>

    <!-- TAB 3: Vi phạm tập thể -->
    <section id="tab-tapthe" class="card hidden">
      <div class="grid">
        <div><label>Người khai báo *</label><input id="tt-redstart" type="text"></div>
        <div><label>Ca học *</label><select id="tt-session"><option>Ca sáng</option><option>Ca chiều</option></select></div>
        <div style="grid-column:1/-1"><label>Người phụ trách *</label><select id="tt-responsive"></select></div>
      </div>
      <div id="tt-list"></div>
      <div class="row" style="margin-top:8px"><button class="btn secondary" id="tt-add">+ Thêm tập thể</button></div>
      <div style="margin-top:8px"><button class="btn primary" id="tt-submit">Gửi tất cả</button></div>
      <div id="tt-status" class="status"></div>
    </section>
  </main>
</div>

<div id="notice"><span id="notice-msg"></span></div>

<!-- Modal mức phạt -->
<div id="fee-modal" class="hidden">
  <div style="background:#fff;padding:16px;border-radius:16px;max-width:600px;margin:50px auto">
    <h3>Mức phạt & Chuyển khoản</h3>
    <p><strong>Vệ sinh lớp học:</strong> 50.000 VNĐ</p>
    <p><strong>Hút thuốc:</strong> 200.000 VNĐ</p>
    <img src="https://raw.githubusercontent.com/duongcanhquan/image/refs/heads/main/vcb.png" style="width:100%;max-width:300px;border:1px solid #ccc;border-radius:8px">
    <div style="text-align:right;margin-top:12px"><button class="btn ghost" id="fee-close">Đóng</button></div>
  </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbyOOfs0l5NZX5mwphOer68qZKAM3V2ZtFDqagYhkhV2g8BXrauOr0hLi1BwFf2eEHyCWQ/exec';
const $=(s,el=document)=>el.querySelector(s),$$=(s,el=document)=>[...el.querySelectorAll(s)];

$$('.tab').forEach(btn=>{
  btn.onclick=()=>{
    $$('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    $$('main section').forEach(s=>s.classList.add('hidden'));
    $('#tab-'+btn.dataset.tab).classList.remove('hidden');
  }
});

function showNotice(msg,ok=false){
  const n=$('#notice'); $('#notice-msg').textContent=msg; n.classList.toggle('ok',ok); n.style.display='block';
  setTimeout(()=>n.style.display='none',4000);
}

// Compress image for faster upload
async function compressImage(file, maxW=1600, quality=0.8){
  if(!file.type.startsWith('image/')) return file;
  const img = await new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=fr.result};
    fr.readAsDataURL(file);
  });
  const scale = Math.min(1, maxW/img.width);
  const cv = document.createElement('canvas'); cv.width=img.width*scale; cv.height=img.height*scale;
  cv.getContext('2d').drawImage(img,0,0,cv.width,cv.height);
  const blob = await new Promise(r=>cv.toBlob(r,'image/jpeg',quality));
  return new File([blob],file.name.replace(/\.\w+$/,'.jpg'),{type:'image/jpeg'});
}
async function filesToPayload(fileList,limit=3){
  const files=[...(fileList||[])].slice(0,limit);
  return Promise.all(files.map(async f=>{
    const c=await compressImage(f);
    const fr=new FileReader();
    const data=await new Promise(r=>{fr.onload=()=>r(fr.result);fr.readAsDataURL(c)});
    return {name:c.name,type:c.type,data:data.split(',')[1]};
  }));
}
async function apiPost(action,payload){
  const fd=new FormData();
  fd.append('action',action);
  fd.append('payload',JSON.stringify(payload));
  const r=await fetch(API_URL,{method:'POST',body:fd});
  return r.json();
}

/* ============== HOẠT ĐỘNG SAO ĐỎ ============== */
const hdList=$('#hd-list');let hdCount=0;
function hdItem(i){return`
<div class="card" data-hd="${i}">
  <div class="grid">
    <div><label>Người vi phạm *</label><input type="text" class="hd-name"></div>
    <div><label>Lớp *</label><input type="text" class="hd-class"></div>
    <div style="grid-column:1/-1"><label>Mô tả vi phạm *</label><textarea class="hd-problems"></textarea></div>
    <div style="grid-column:1/-1" class="fieldset"><h4>Ảnh vi phạm (tối đa 3)</h4><input type="file" class="hd-photos" multiple accept="image/*"></div>
    <div style="grid-column:1/-1;text-align:right"><button class="btn ghost hd-remove" type="button">Xóa dòng</button></div>
  </div>
</div>`;}
function addHdItem(){const i=hdCount++;const div=document.createElement('div');div.innerHTML=hdItem(i);const el=div.firstElementChild;hdList.appendChild(el);$('.hd-remove',el).onclick=()=>el.remove();}
for(let i=0;i<3;i++) addHdItem();
$('#hd-add').onclick=addHdItem;
$('#hd-submit').onclick=async()=>{
  const Redstart=$('#hd-redstart').value.trim();const Session=$('#hd-session').value;
  const items=$$('[data-hd]',hdList);if(!Redstart||!items.length)return showNotice('Vui lòng nhập đủ thông tin.');
  let ok=0;
  for(const c of items){
    const Name=$('.hd-name',c).value.trim(),Class=$('.hd-class',c).value.trim(),Problems=$('.hd-problems',c).value.trim();
    if(!Name||!Class||!Problems)return showNotice('Thiếu dữ liệu trong một dòng.');
    const files=await filesToPayload($('.hd-photos',c).files,3);
    const r=await apiPost('saveHoatDongSaodo',{Name,Class,Problems,Session,Redstart,files});
    if(r.success)ok++;
  }
  showNotice(ok>0?'Đã gửi '+ok+' dòng.':'Không thể gửi.',ok>0);
};

/* NGƯỜI PHỤ TRÁCH */
const RESPONSIVE_LIST=['Đinh Thị Phương Hà','Dung Nguyễn','Lê Thị Quỳnh Mai','Đinh Thị Hiền','Phùng Khánh Ly','Ngô Thị Nhã Uyên','Đinh Thị Hà','Trần Hồng Hạnh'];
$('#cn-responsive').innerHTML=RESPONSIVE_LIST.map(n=>`<option>${n}</option>`).join('');
$('#tt-responsive').innerHTML=RESPONSIVE_LIST.map(n=>`<option>${n}</option>`).join('');

/* ============== VI PHẠM CÁ NHÂN ============== */
const cnList=$('#cn-list');let cnCount=0;
function cnItem(i){return`
<div class="card" data-cn="${i}">
  <div class="grid">
    <div><label>Người vi phạm *</label><input class="cn-name"></div>
    <div><label>Lớp *</label><input class="cn-class"></div>
    <div style="grid-column:1/-1"><label>Mô tả *</label><textarea class="cn-problems"></textarea></div>
    <div style="grid-column:1/-1" class="fieldset"><h4>Ảnh vi phạm</h4><input type="file" class="cn-photos" multiple accept="image/*"></div>
    <div class="fieldset" style="grid-column:1/-1"><h4>Biên bản</h4><input type="file" class="cn-doc" accept="image/*,application/pdf"></div>
    <div><label>Mức phạt (VNĐ)</label><input type="number" class="cn-fine"></div>
    <div class="fieldset" style="grid-column:1/-1"><h4>Minh chứng nộp phạt</h4><input type="file" class="cn-proof" accept="image/*,application/pdf"></div>
    <div style="grid-column:1/-1;text-align:right"><button class="btn ghost cn-remove">Xóa dòng</button></div>
  </div>
</div>`;}
function addCnItem(){const i=cnCount++;const div=document.createElement('div');div.innerHTML=cnItem(i);const el=div.firstElementChild;cnList.appendChild(el);$('.cn-remove',el).onclick=()=>el.remove();}
addCnItem();
$('#cn-add').onclick=addCnItem;
$('#cn-submit').onclick=async()=>{
  const Redstart=$('#cn-redstart').value.trim(),Session=$('#cn-session').value,Responsive=$('#cn-responsive').value;
  const items=$$('[data-cn]',cnList);if(!Redstart||!items.length)return showNotice('Vui lòng nhập đủ thông tin.');
  const entries=[];
  for(const c of items){
    const Name=$('.cn-name',c).value.trim(),Class=$('.cn-class',c).value.trim(),Problems=$('.cn-problems',c).value.trim();
    if(!Name||!Class||!Problems)return showNotice('Thiếu dữ liệu.');
    const files=await filesToPayload($('.cn-photos',c).files,3);
    const doc=await filesToPayload($('.cn-doc',c).files,1);
    const FineAmount=Number($('.cn-fine',c).value||0);
    const FineProof=await filesToPayload($('.cn-proof',c).files,1);
    entries.push({Name,Class,Problems,Session,Responsive,files,doc,FineAmount,FineProof});
  }
  const r=await apiPost('saveViphamCanhan',{Redstart,entries});
  showNotice(r.success?'Đã gửi thành công.':'Không thể gửi.',r.success);
};

/* ============== VI PHẠM TẬP THỂ ============== */
const ttList=$('#tt-list');let ttCount=0;
function ttItem(i){return`
<div class="card" data-tt="${i}">
  <div class="grid">
    <div><label>Lớp *</label><input class="tt-class"></div>
    <div><label>Phòng học</label><input class="tt-room"></div>
    <div style="grid-column:1/-1"><label>Mô tả *</label><textarea class="tt-problems"></textarea></div>
    <div style="grid-column:1/-1" class="fieldset"><h4>Ảnh vi phạm</h4><input type="file" class="tt-photos" multiple accept="image/*"></div>
    <div class="fieldset" style="grid-column:1/-1"><h4>Biên bản</h4><input type="file" class="tt-doc" accept="image/*,application/pdf"></div>
    <div><label>Mức phạt (VNĐ)</label><input type="number" class="tt-fine"></div>
    <div class="fieldset" style="grid-column:1/-1"><h4>Minh chứng nộp phạt</h4><input type="file" class="tt-proof" accept="image/*,application/pdf"></div>
    <div style="grid-column:1/-1;text-align:right"><button class="btn ghost tt-remove">Xóa dòng</button></div>
  </div>
</div>`;}
function addTtItem(){const i=ttCount++;const div=document.createElement('div');div.innerHTML=ttItem(i);const el=div.firstElementChild;ttList.appendChild(el);$('.tt-remove',el).onclick=()=>el.remove();}
addTtItem();
$('#tt-add').onclick=addTtItem;
$('#tt-submit').onclick=async()=>{
  const Redstart=$('#tt-redstart').value.trim(),Session=$('#tt-session').value,Responsive=$('#tt-responsive').value;
  const items=$$('[data-tt]',ttList);if(!Redstart||!items.length)return showNotice('Vui lòng nhập đủ thông tin.');
  const entries=[];
  for(const c of items){
    const Class=$('.tt-class',c).value.trim(),Room=$('.tt-room',c).value.trim(),Problems=$('.tt-problems',c).value.trim();
    if(!Class||!Problems)return showNotice('Thiếu dữ liệu.');
    const files=await filesToPayload($('.tt-photos',c).files,3);
    const doc=await filesToPayload($('.tt-doc',c).files,1);
    const FineAmount=Number($('.tt-fine',c).value||0);
    const FineProof=await filesToPayload($('.tt-proof',c).files,1);
    entries.push({Class,Room,Problems,Session,Responsive,files,doc,FineAmount,FineProof});
  }
  const r=await apiPost('saveBaoloiTapthe',{Redstart,entries});
  showNotice(r.success?'Đã gửi thành công.':'Không thể gửi.',r.success);
};
</script>
</body>
</html>
