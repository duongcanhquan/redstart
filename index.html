<script>
  /* (A) ĐỔI CHUỖI NÀY THÀNH URL /exec THẬT CỦA BẠN (Web App) */
  const API_URL = 'https://script.google.com/macros/s/AKfycbw0gqKwbk9pR5F9RSd8KBngbVb_5Zfe-S5uUUtXLEBincL8AdjMFBQ5zqdEWNLdXM7P3w/exec';

  const $  = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>[...r.querySelectorAll(s)];

  /* Tabs */
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const target = 'tab-' + btn.dataset.tab;
      $$('main section').forEach(sec => sec.classList.add('hidden'));
      $('#'+target).classList.remove('hidden');
      setTimeout(()=>{ window.scrollBy({top:1}); }, 0);
    });
  });

  /* THÔNG BÁO */
  function showNotice(msg, ok=false){
    const box = $('#notice'), span = $('#notice-msg');
    span.textContent = msg || 'Nội dung cần hoàn thiện.';
    box.classList.toggle('ok', !!ok);
    box.style.display = 'block';
    setTimeout(()=>{ box.style.display='none'; }, 5000);
  }
  function hideNotice(){ $('#notice').style.display='none'; }

  /* Xác nhận cuối trang */
  function showConfirm(){
    const c = $('#confirm');
    c.style.display = 'block';
    c.scrollIntoView({behavior:'smooth', block:'end'});
    setTimeout(()=>{ c.style.display='none'; }, 6000);
  }

  /* Người phụ trách (cố định) */
  const RESPONSIVE_LIST = [
    'Đinh Thị Phương Hà','Dung Nguyễn','Lê Thị Quỳnh Mai','Đinh Thị Hiền',
    'Phùng Khánh Ly','Ngô Thị Nhã Uyên','Đinh Thị Hà','Trần Hồng Hạnh'
  ];
  $('#cn-responsive').innerHTML = RESPONSIVE_LIST.map(n=>`<option>${n}</option>`).join('');
  $('#tt-responsive').innerHTML = RESPONSIVE_LIST.map(n=>`<option>${n}</option>`).join('');

  /* Files -> base64 */
  async function filesToPayload(fileList, limit=3){
    const files=[...(fileList||[])].slice(0,limit);
    const jobs=files.map(file=>new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=()=>res({name:file.name,type:file.type,data:fr.result.split(',')[1]});
      fr.onerror=rej; fr.readAsDataURL(file);
    }));
    return Promise.all(jobs);
  }

  /* (C) API – không set headers để tránh CORS; log lỗi rõ ràng */
  async function apiPost(action, payload){
    if(!API_URL || !/\/exec$/.test(API_URL)){
      showNotice('THÔNG BÁO: API_URL chưa đúng /exec. Vui lòng cấu hình lại.', false);
      throw new Error('API_URL invalid');
    }
    const fd=new FormData();
    fd.append('action', action);
    fd.append('payload', JSON.stringify(payload));
    const res = await fetch(API_URL, { method:'POST', body:fd });

    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { data = { success:false, raw:text }; }

    if(!res.ok || data.success === false){
      console.error('Apps Script error:', { status: res.status, data });
      showNotice('THÔNG BÁO: Không thể lưu. Vui lòng thử lại.', false);
      throw new Error(`HTTP ${res.status}: ${data.error || data.raw || 'unknown'}`);
    }
    return data;
  }

  /* Khóa nút sau thành công (tránh gửi trùng) */
  const busy = { hd:false, cn:false, tt:false };
  function lockAfterSuccess(sectionKey, btnEl, statusEl){
    busy[sectionKey] = true;
    btnEl.disabled = true;
    statusEl.className = 'status ok';
    statusEl.textContent = 'THÔNG BÁO: Đã gửi thành công. Nút gửi đã khóa để tránh trùng lặp.';
  }
  function unlockForEditing(sectionKey, btnEl, statusEl){
    busy[sectionKey] = false;
    btnEl.disabled = false;
    statusEl.textContent = '';
    statusEl.className = 'status';
  }
  function attachChangeUnlock(sectionKey, containerSel, btnSel, statusSel){
    const container = $(containerSel);
    const btn = $(btnSel);
    const status = $(statusSel);
    container.addEventListener('input', ()=>{ if (btn.disabled) unlockForEditing(sectionKey, btn, status); });
  }

  /* TAB 1 */
  attachChangeUnlock('hd', '#tab-hoatdong', '#hd-submit', '#hd-status');
  $('#hd-submit').addEventListener('click', async ()=>{
    if(busy.hd) return; busy.hd = true; $('#hd-submit').disabled = true;
    const statusEl = $('#hd-status');

    const data = {
      Redstart: $('#hd-redstart').value.trim(),
      Name:     $('#hd-name').value.trim(),
      Class:    $('#hd-class').value.trim(),
      Problems: $('#hd-problems').value.trim(),
      Session:  $('#hd-session').value,
      files:    await filesToPayload($('#hd-photos').files, 3)
    };
    if(!data.Redstart || !data.Name || !data.Class || !data.Problems){
      showNotice('THÔNG BÁO: Nội dung chưa hoàn thiện. Vui lòng hoàn thiện.', false);
      busy.hd=false; $('#hd-submit').disabled=false; return;
    }
    try{
      const r = await apiPost('saveHoatDongSaodo', data);
      if(r.success){
        ['hd-redstart','hd-name','hd-class','hd-problems'].forEach(id=>$('#'+id).value='');
        $('#hd-photos').value=''; $('#hd-session').selectedIndex=0;
        showConfirm();
        lockAfterSuccess('hd', $('#hd-submit'), statusEl);
        showNotice('THÔNG BÁO: Hệ thống đã ghi nhận thông tin.', true);
      } else {
        showNotice('THÔNG BÁO: Không thể lưu. Vui lòng thử lại.', false);
        busy.hd=false; $('#hd-submit').disabled=false;
      }
    }catch(e){
      console.error(e);
      busy.hd=false; $('#hd-submit').disabled=false;
    }
  });
  $('#hd-reset').addEventListener('click', ()=>{
    ['hd-redstart','hd-name','hd-class','hd-problems'].forEach(id=>$('#'+id).value='');
    $('#hd-photos').value=''; $('#hd-session').selectedIndex=0;
    unlockForEditing('hd', $('#hd-submit'), $('#hd-status'));
  });

  /* TAB 2 */
  const cnList = $('#cn-list'); let cnCount = 0;
  function cnItemTemplate(i){
    return `
    <div class="card" data-cn="${i}">
      <div class="grid">
        <div><label>Người vi phạm *</label><input type="text" class="cn-name" /></div>
        <div><label>Lớp *</label><input type="text" class="cn-class" /></div>
        <div style="grid-column:1/-1"><label>Mô tả vi phạm *</label><textarea class="cn-problems"></textarea></div>

        <div style="grid-column:1/-1" class="fieldset">
          <h4>Ảnh vi phạm (tối đa 3)</h4>
          <input type="file" class="cn-photos" multiple accept="image/*" />
        </div>

        <div style="grid-column:1/-1" class="fieldset">
          <h4>Biên bản (tối đa 1 file)</h4>
          <input type="file" class="cn-doc" accept="image/*,application/pdf" />
        </div>

        <div style="grid-column:1/-1" class="row">
          <button class="btn ghost cn-remove" type="button">Xóa dòng</button>
        </div>
      </div>
    </div>`;
  }
  function addCnItem(){
    const i=cnCount++; const wrap=document.createElement('div'); wrap.innerHTML=cnItemTemplate(i);
    const el=wrap.firstElementChild; cnList.appendChild(el);
    $$('.cn-remove', el).forEach(btn=>{ btn.onclick=(e)=> e.currentTarget.closest('[data-cn]').remove(); });
    setTimeout(()=>{ el.scrollIntoView({behavior:'smooth', block:'start'}); },0);
  }
  $('#cn-add').addEventListener('click', addCnItem);
  addCnItem();

  attachChangeUnlock('cn', '#tab-canhan', '#cn-submit', '#cn-status');

  $('#cn-reset').addEventListener('click', ()=>{
    $('#cn-redstart').value=''; $('#cn-session').selectedIndex=0;
    cnList.innerHTML=''; cnCount=0; addCnItem();
    unlockForEditing('cn', $('#cn-submit'), $('#cn-status'));
    window.scrollBy({top:1});
  });

  $('#cn-submit').addEventListener('click', async ()=>{
    if(busy.cn) return; busy.cn=true; $('#cn-submit').disabled=true;
    const statusEl = $('#cn-status');

    const Redstart = $('#cn-redstart').value.trim();
    const Session  = $('#cn-session').value;
    const Responsive = $('#cn-responsive').value;
    const cards = $$('[data-cn]', cnList);

    if(!Redstart || cards.length===0){
      showNotice('THÔNG BÁO: Nội dung chưa hoàn thiện. Vui lòng hoàn thiện.', false);
      busy.cn=false; $('#cn-submit').disabled=false; return;
    }

    const entries=[];
    for (const card of cards){
      const name = $('.cn-name', card).value.trim();
      const cls  = $('.cn-class', card).value.trim();
      const prob = $('.cn-problems', card).value.trim();
      if(!name || !cls || !prob){
        showNotice('THÔNG BÁO: Nội dung chưa hoàn thiện. Vui lòng hoàn thiện.', false);
        busy.cn=false; $('#cn-submit').disabled=false; return;
      }
      const files = await filesToPayload($('.cn-photos', card).files, 3);
      const doc   = await filesToPayload($('.cn-doc', card).files, 1);
      entries.push({ Name:name, Class:cls, Problems:prob, Session, Responsive, files, doc });
    }

    try{
      const r = await apiPost('saveViphamCanhan', { Redstart, entries });
      if(r.success){
        $('#cn-redstart').value=''; $('#cn-session').selectedIndex=0;
        cnList.innerHTML=''; cnCount=0; addCnItem();
        showConfirm();
        lockAfterSuccess('cn', $('#cn-submit'), statusEl);
        showNotice('THÔNG BÁO: Hệ thống đã ghi nhận thông tin.', true);
      } else {
        showNotice('THÔNG BÁO: Không thể lưu. Vui lòng thử lại.', false);
        busy.cn=false; $('#cn-submit').disabled=false;
      }
    }catch(e){
      console.error(e);
      showNotice('THÔNG BÁO: Kết nối không thành công. Kiểm tra API.', false);
      busy.cn=false; $('#cn-submit').disabled=false;
    }
  });

  /* TAB 3 */
  const ttList = $('#tt-list'); let ttCount = 0;
  function ttItemTemplate(i){
    return `
    <div class="card" data-tt="${i}">
      <div class="grid">
        <div><label>Lớp *</label><input type="text" class="tt-class" /></div>
        <div><label>Phòng học</label><input type="text" class="tt-room" placeholder="VD: P201" /></div>
        <div style="grid-column:1/-1"><label>Mô tả vi phạm *</label><textarea class="tt-problems"></textarea></div>

        <div style="grid-column:1/-1" class="fieldset">
          <h4>Ảnh vi phạm (tối đa 3)</h4>
          <input type="file" class="tt-photos" multiple accept="image/*" />
        </div>

        <div style="grid-column:1/-1" class="fieldset">
          <h4>Biên bản (tối đa 1 file)</h4>
          <input type="file" class="tt-doc" accept="image/*,application/pdf" />
        </div>

        <div style="grid-column:1/-1" class="row">
          <button class="btn ghost tt-remove" type="button">Xóa dòng</button>
        </div>
      </div>
    </div>`;
  }
  function addTtItem(){
    const i=ttCount++; const wrap=document.createElement('div'); wrap.innerHTML=ttItemTemplate(i);
    const el=wrap.firstElementChild; ttList.appendChild(el);
    $$('.tt-remove', el).forEach(btn=>{ btn.onclick=(e)=> e.currentTarget.closest('[data-tt]').remove(); });
    setTimeout(()=>{ el.scrollIntoView({behavior:'smooth', block:'start'}); },0);
  }
  $('#tt-add').addEventListener('click', addTtItem);
  addTtItem();

  attachChangeUnlock('tt', '#tab-tapthe', '#tt-submit', '#tt-status');

  $('#tt-reset').addEventListener('click', ()=>{
    $('#tt-redstart').value=''; $('#tt-session').selectedIndex=0;
    ttList.innerHTML=''; ttCount=0; addTtItem();
    unlockForEditing('tt', $('#tt-submit'), $('#tt-status'));
    window.scrollBy({top:1});
  });

  $('#tt-submit').addEventListener('click', async ()=>{
    if(busy.tt) return; busy.tt=true; $('#tt-submit').disabled=true;
    const statusEl = $('#tt-status');

    const Redstart = $('#tt-redstart').value.trim();
    const Session  = $('#tt-session').value;
    const Responsive = $('#tt-responsive').value;
    const cards = $$('[data-tt]', ttList);

    if(!Redstart || cards.length===0){
      showNotice('THÔNG BÁO: Nội dung chưa hoàn thiện. Vui lòng hoàn thiện.', false);
      busy.tt=false; $('#tt-submit').disabled=false; return;
    }

    const entries=[];
    for (const card of cards){
      const cls  = $('.tt-class', card).value.trim();
      const room = $('.tt-room', card).value.trim();
      const prob = $('.tt-problems', card).value.trim();
      if(!cls || !prob){
        showNotice('THÔNG BÁO: Nội dung chưa hoàn thiện. Vui lòng hoàn thiện.', false);
        busy.tt=false; $('#tt-submit').disabled=false; return;
      }
      const files = await filesToPayload($('.tt-photos', card).files, 3);
      const doc   = await filesToPayload($('.tt-doc', card).files, 1);
      entries.push({ Class:cls, Room:room, Problems:prob, Session, Responsive, files, doc });
    }

    try{
      const r = await apiPost('saveBaoloiTapthe', { Redstart, entries });
      if(r.success){
        $('#tt-redstart').value=''; $('#tt-session').selectedIndex=0;
        ttList.innerHTML=''; ttCount=0; addTtItem();
        showConfirm();
        lockAfterSuccess('tt', $('#tt-submit'), statusEl);
        /* (B) Sửa lỗi cú pháp ở đây */
        showNotice('THÔNG BÁO: Hệ thống đã ghi nhận thông tin.', true);
      } else {
        showNotice('THÔNG BÁO: Không thể lưu. Vui lòng thử lại.', false);
        busy.tt=false; $('#tt-submit').disabled=false;
      }
    }catch(e){
      console.error(e);
      showNotice('THÔNG BÁO: Kết nối không thành công. Kiểm tra API.', false);
      busy.tt=false; $('#tt-submit').disabled=false;
    }
  });
</script>
